# configure sshd
# >>> /etc/update-motd.d/10-uname
---
- name: install support packages
  ansible.builtin.package:
    name:
      - figlet
    state: latest

- name: disable root login via ssh
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^PermitRootLogin yes'
    line: 'PermitRootLogin no'

- name: disable password authentication
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^PasswordAuthentication yes'
    line: 'PasswordAuthentication no'

- name: enable banner file
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#Banner none'
    line: 'Banner /etc/banner.txt'

- name: install banner file
  ansible.builtin.template:
    src: banner.j2
    dest: /etc/banner.txt
    owner: root
    group: root
    mode: '0640'
  with_random_choice:
    - “All we have to decide is what to do with the time that is given us.”
    - "End of line."
    - "life is not a problem to be solved; it is a reality to be experienced."
    - "Come on, you scuzzy data, be in there."
    - "Never tell me the odds!"
    - "I never asked for this. They say they saved me, but I'm not sure saved is the right word."

- name: enable motd
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^PrintMotd no'
    line: 'PrintMotd yes'

- name: install motd figlet script
  ansible.builtin.template:
    src: figlet_motd.sh.j2
    dest: /usr/local/sbin/figlet_motd.sh
    owner: root
    group: root
    mode: '0740'

- name: install motd file on Debian
  ansible.builtin.template:
    src: motd.j2
    dest: /etc/motd
    owner: root
    group: root
    mode: '0644'

- name: update motd with figlet doodle
  become: true
  ansible.builtin.command:
    cmd: /usr/local/sbin/figlet_motd.sh

- name: reload sshd if RedHat
  ansible.builtin.service:
    name: sshd
    state: reloaded
  when: ansible_os_family == 'RedHat'

- name: reload ssh if Debian
  ansible.builtin.service:
    name: ssh
    state: reloaded
  when: ansible_os_family == 'Debian'
